(()=>{var s=class{constructor(e,t){this.message=e,this.data=t??e}toString(){return this.message}};var o=class{constructor(e,t){this.increaseBytesUploaded=e=>(this.uploadedBytes+=e,this);this.calcul=()=>{let e=(Date.now()-this.timeStarted.getTime())/1e3,t=this.uploadedBytes/e;return Math.max(Math.floor((this.totalSize-this.uploadedBytes)/t),0)};this.timeStarted=e,this.totalSize=t,this.uploadedBytes=0}};function d(a){return a.replace(/\/+$/,"")}function m(a){return Object.keys(a).map(e=>`${e}=${a[e]}`).join("&")}var h=!1;function c(a,e=0){return(...t)=>{h||(h=!0,setTimeout(()=>{a.apply(null,t),h=!1},e))}}var u=class{constructor(){this.file=null;this.fileId=null;this.chunkNumber=1;this.chunkSize=10485760;this.chunkCount=1;this.uploadStatusUrl=null;this.uploadUrl=null;this.progressThrottleTime=3e3;this.requestTimeout=null;this.xhr=new XMLHttpRequest;this.remainingTimeCalculator=new o(new Date,0);this.uploadAborted=!1;this.headers={};this.handleProgress=null;this.checkParameters=async()=>{if(!this.file)throw new s("NO_FILE");if(!this.getFileId())throw new s("NO_FILE_ID");if(typeof this.uploadStatusUrl!="string")throw new s("NO_UPLOAD_STATUS_URL");if(typeof this.uploadUrl!="string")throw new s("NO_UPLOAD_URL");return!0};this.getUploadStatus=async()=>new Promise((e,t)=>{this.chunkCount=Math.ceil(this.file.size/this.chunkSize);let i=m({fileId:this.getFileId(),chunkCount:this.chunkCount}),r=new XMLHttpRequest;r.open("GET",`${this.uploadStatusUrl}?${i}`,!0),r.responseType="json",this.requestTimeout!==null&&(r.timeout=this.requestTimeout),Object.keys(this.headers).forEach(n=>{r.setRequestHeader(n,this.headers[n])}),r.ontimeout=()=>{t(new s("REQUEST_TIMEOUT",r))},r.onerror=r.onabort=()=>{t(new s("GET_LAST_CHUNK_UPLOADED",r))},r.onload=()=>{r.status===200?e(r.response.lastChunk):t(new s("GET_LAST_CHUNK_UPLOADED",r))},r.send()});this.uploadFile=async()=>new Promise((e,t)=>{let i=this.xhr;i.open("POST",`${this.uploadUrl}`,!0),i.responseType="json",this.requestTimeout!==null&&(i.timeout=this.requestTimeout),Object.keys(this.headers).forEach(n=>{i.setRequestHeader(n,this.headers[n])});let r=new FormData;r.append("file",this.getChunk()),r.append("fileId",this.getFileId().toString()),r.append("chunkCount",this.chunkCount.toString()),r.append("chunkSize",this.chunkSize.toString()),r.append("chunkNumber",this.chunkNumber.toString()),r.append("fileSize",this.file.size.toString()),r.append("originalFilename",this.file.name),i.onload=i.onerror=n=>{i.status===200?this.chunkNumber<this.chunkCount?(this.chunkNumber++,this.uploadFile().then(e).catch(t)):e(i):(this.chunkNumber=1,t(new s("UPLOAD_FILE_ERROR",i)))},i.onabort=n=>{t(new s("UPLOAD_ABORTED",i))},i.ontimeout=()=>{t(new s("REQUEST_TIMEOUT",i))},i.upload.onprogress=c(n=>{if(this.uploadAborted)return;let p=(this.chunkNumber-1)*this.chunkSize+n.loaded,f=this.file.size,g=Math.min(Math.ceil(p/f*100),100),l=this.chunkNumber===this.chunkCount;this.handleProgress&&this.handleProgress({percent:l?100:g,loaded:l?this.file.size:p,remaining:l?0:this.remainingTimeCalculator.increaseBytesUploaded(n.loaded).calcul()})},this.progressThrottleTime),i.send(r)});this.upload=async()=>{try{await this.checkParameters();let e=await this.getUploadStatus();this.chunkNumber=e+1;let t=this.file.slice((this.chunkNumber-1)*this.chunkSize).size;return this.remainingTimeCalculator=new o(new Date,t),this.uploadAborted=!1,await this.uploadFile()}catch(e){throw e}};this.onProgress=(e,t)=>(this.handleProgress=e,t&&t>=0&&(this.progressThrottleTime=t),this);this.abort=()=>{this.uploadAborted=!0,this.xhr.abort()};this.getChunk=()=>{let e=(this.chunkNumber-1)*this.chunkSize,t=Math.min(e+this.chunkSize,this.file.size);return this.file.slice(e,t)};this.getFileId=()=>{let e=this.file.name.split(".").pop(),t=`${this.file.size}-${this.file.lastModified}.${e}`;return this.fileId??t};this.setUploadStatusUrl=e=>(this.uploadStatusUrl=d(e),this);this.setUploadUrl=e=>(this.uploadUrl=d(e),this);this.setFile=e=>(this.file=e,this);this.setChunkSize=e=>(this.chunkSize=e,this);this.setFileId=e=>(this.fileId=e,this);this.setHeaders=e=>(this.headers=e??{},this);this.setRequestTimeout=e=>(this.requestTimeout=e,this)}};var z=u;window.Uploader=u;window.UploadError=s;})();
