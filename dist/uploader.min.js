(()=>{var k=Object.defineProperty;var m=(i,e,t)=>e in i?k(i,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):i[e]=t;var l=(i,e,t)=>(m(i,typeof e!="symbol"?e+"":e,t),t);var o=class{baseUrl=null;file=null;fileId="";chunkNumber=1;chunkSize=10485760;chunkCount=1;lastChunkUploadedPath="/lastChunkUploaded";uploadPath="/upload";progressTimeout=3e3;xrh=new XMLHttpRequest;remainingTimeCalculator=new r(new Date,0);uploadAborted=!1;onProgress=()=>{};getLastChunkUploaded=()=>new Promise((e,t)=>{this.chunkCount=Math.ceil(this.file.size/this.chunkSize);let h=U({fileId:this.getFileId(),chunkCount:this.chunkCount}),s=new XMLHttpRequest;s.open("GET",`${this.baseUrl}${this.lastChunkUploadedPath}?${h}`,!0),s.responseType="json",s.onerror=s.onabort=()=>{t(new n(n.GET_LAST_CHUNK_UPLOADED,s))},s.onload=()=>{s.status===200?e(s.response.lastChunk):t(new n(n.GET_LAST_CHUNK_UPLOADED,s))},s.send()});uploadFile=()=>new Promise((e,t)=>{let h=this.xrh;h.open("POST",`${this.baseUrl}${this.uploadPath}`,!0),h.responseType="json";let s=new FormData;s.append("file",this.getChunk()),s.append("fileId",this.getFileId()),s.append("chunkCount",this.chunkCount),s.append("chunkSize",this.chunkSize),s.append("chunkNumber",this.chunkNumber),s.append("fileSize",this.file.size),s.append("originalFilename",this.file.name),h.onload=h.onerror=a=>{h.status===200?(this.chunkNumber++,this.chunkNumber<=this.chunkCount?this.uploadFile():e(h)):(this.chunkNumber=1,t(new n(n.UPLOAD_FILE_ERROR,h)))},h.onabort=a=>{this.chunkNumber=1,t(new n(n.UPLOAD_ABORTED,h))},h.upload.onprogress=P(a=>{if(this.uploadAborted)return;let d=(this.chunkNumber-1)*this.chunkSize+a.loaded,c=this.file.size,p=Math.min(Math.ceil(d/c*100),100);this.onProgress&&this.onProgress({percent:p,loaded:d,remaining:this.remainingTimeCalculator.increaseBytesUploaded(a.loaded).calcul(this.chunkLoaded)})},this.progressTimeout),h.send(s)});upload=async()=>{try{let e=await this.getLastChunkUploaded();this.chunkNumber=e+1;let t=this.file.slice((this.chunkNumber-1)*this.chunkSize).size;return this.remainingTimeCalculator=new r(new Date,t),this.uploadAborted=!1,await this.uploadFile(),this.xhr}catch(e){throw e}};onProgress=(e,t)=>(this.onProgress=e,t>=0&&(this.progressTimeout=parseInt(t)),this);abort=()=>{this.uploadAborted=!0,this.xrh.abort()};getChunk=()=>{let e=(this.chunkNumber-1)*this.chunkSize,t=Math.min(e+this.chunkSize,this.file.size);return this.file.slice(e,t)};getFileId=()=>{let e=this.file.name.split(".").pop(),t=`${this.file.size}-${this.file.lastModified}.${e}`;return this.fileId||t};setBaseUrl=e=>(this.baseUrl=f(e),this);setFile=e=>(this.file=e,this);setChunkSize=e=>(this.chunkSize=parseInt(e),this);setFileId=e=>(this.fileId=e,this)},r=class{constructor(e,t){this.timeStarted=e,this.totalSize=t,this.uploadedBytes=0}increaseBytesUploaded=e=>(this.uploadedBytes+=e,this);calcul=()=>{let e=(Date.now()-this.timeStarted.getTime())/1e3,t=this.uploadedBytes/e;return Math.max(Math.floor((this.totalSize-this.uploadedBytes)/t),0)}},n=class{constructor(e,t){this.message=e,this.data=t}};l(n,"GET_LAST_CHUNK_UPLOADED","GET_LAST_CHUNK_UPLOADED"),l(n,"UPLOAD_FILE_ERROR","UPLOAD_FILE_ERROR"),l(n,"UPLOAD_ABORTED","UPLOAD_ABORTED");var f=i=>i.replace(/\/+$/,""),U=i=>Object.keys(i).map(e=>`${e}=${i[e]}`).join("&"),u=!1,P=(i,e=0)=>(...t)=>{u||(u=!0,setTimeout(()=>{i.apply(null,t),u=!1},e))};window.Uploader=o;window.UploadError=n;})();
