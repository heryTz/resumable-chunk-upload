(()=>{var U=Object.defineProperty;var S=(n,t,e)=>t in n?U(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e;var o=(n,t,e)=>(S(n,typeof t!="symbol"?t+"":t,e),e);var s=class{constructor(t,e){this.message=t,this.data=e}toString(){return this.message}};o(s,"GET_LAST_CHUNK_UPLOADED","GET_LAST_CHUNK_UPLOADED"),o(s,"UPLOAD_FILE_ERROR","UPLOAD_FILE_ERROR"),o(s,"UPLOAD_ABORTED","UPLOAD_ABORTED"),o(s,"REQUEST_TIMEOUT","REQUEST_TIMEOUT"),o(s,"INVALID_CONFIGURATION","INVALID_CONFIGURATION");var a=class{constructor(t,e){this.timeStarted=t,this.totalSize=e,this.uploadedBytes=0}increaseBytesUploaded=t=>(this.uploadedBytes+=t,this);calcul=()=>{let t=(Date.now()-this.timeStarted.getTime())/1e3,e=this.uploadedBytes/t;return Math.max(Math.floor((this.totalSize-this.uploadedBytes)/e),0)}};function d(n){return n.replace(/\/+$/,"")}function c(n){return Object.keys(n).map(t=>`${t}=${n[t]}`).join("&")}var l=!1;function m(n,t=0){return(...e)=>{l||(l=!0,setTimeout(()=>{n.apply(null,e),l=!1},t))}}var h=class{file=null;fileId=null;chunkNumber=1;chunkSize=10485760;chunkCount=1;uploadStatusUrl=null;uploadUrl=null;progressTimeout=3e3;requestTimeout=null;xhr=new XMLHttpRequest;remainingTimeCalculator=new a(new Date,0);uploadAborted=!1;headers={};onProgress=()=>{};getUploadStatus=async()=>new Promise((t,e)=>{this.chunkCount=Math.ceil(this.file.size/this.chunkSize);let r=c({fileId:this.getFileId(),chunkCount:this.chunkCount});(!Number.isInteger(this.chunkCount)||!this.uploadStatusUrl||!this.uploadUrl)&&e(new s(s.INVALID_CONFIGURATION));let i=new XMLHttpRequest;i.open("GET",`${this.uploadStatusUrl}?${r}`,!0),i.responseType="json",this.requestTimeout!==null&&(i.timeout=this.requestTimeout),Object.keys(this.headers).forEach(u=>{i.setRequestHeader(u,this.headers[u])}),i.ontimeout=()=>{e(new s(s.REQUEST_TIMEOUT,i))},i.onerror=i.onabort=()=>{e(new s(s.GET_LAST_CHUNK_UPLOADED,i))},i.onload=()=>{i.status===200?t(i.response.lastChunk):e(new s(s.GET_LAST_CHUNK_UPLOADED,i))},i.send()});uploadFile=async()=>new Promise((t,e)=>{let r=this.xhr;r.open("POST",`${this.uploadUrl}`,!0),r.responseType="json",this.requestTimeout!==null&&(r.timeout=this.requestTimeout),Object.keys(this.headers).forEach(u=>{r.setRequestHeader(u,this.headers[u])});let i=new FormData;i.append("file",this.getChunk()),i.append("fileId",this.getFileId()),i.append("chunkCount",this.chunkCount),i.append("chunkSize",this.chunkSize),i.append("chunkNumber",this.chunkNumber),i.append("fileSize",this.file.size),i.append("originalFilename",this.file.name),r.onload=r.onerror=u=>{r.status===200?(this.chunkNumber++,this.chunkNumber<=this.chunkCount?this.uploadFile().then(t).catch(e):t(r)):(this.chunkNumber=1,e(new s(s.UPLOAD_FILE_ERROR,r)))},r.onabort=u=>{this.chunkNumber=1,e(new s(s.UPLOAD_ABORTED,r))},r.ontimeout=()=>{e(new s(s.REQUEST_TIMEOUT,r))},r.upload.onprogress=m(u=>{if(this.uploadAborted)return;let p=(this.chunkNumber-1)*this.chunkSize+u.loaded,f=this.file.size,T=Math.min(Math.ceil(p/f*100),100);this.onProgress&&this.onProgress({percent:T,loaded:p,remaining:this.remainingTimeCalculator.increaseBytesUploaded(u.loaded).calcul(this.chunkLoaded)})},this.progressTimeout),r.send(i)});upload=async()=>{try{let t=await this.getUploadStatus();this.chunkNumber=t+1;let e=this.file.slice((this.chunkNumber-1)*this.chunkSize).size;return this.remainingTimeCalculator=new a(new Date,e),this.uploadAborted=!1,await this.uploadFile()}catch(t){throw t}};onProgress=(t,e)=>(this.onProgress=t,e>=0&&(this.progressTimeout=parseInt(e)),this);abort=()=>{this.uploadAborted=!0,this.xhr.abort()};getChunk=()=>{let t=(this.chunkNumber-1)*this.chunkSize,e=Math.min(t+this.chunkSize,this.file.size);return this.file.slice(t,e)};getFileId=()=>{let t=this.file.name.split(".").pop(),e=`${this.file.size}-${this.file.lastModified}.${t}`;return this.fileId||e};setUploadStatusUrl=t=>(this.uploadStatusUrl=d(t),this);setUploadUrl=t=>(this.uploadUrl=d(t),this);setFile=t=>(this.file=t,this);setChunkSize=t=>(this.chunkSize=t,this);setFileId=t=>(this.fileId=t,this);setHeaders=t=>(this.headers=t??{},this);setRequestTimeout=t=>(this.requestTimeout=t,this)};var C=h;window.Uploader=h;window.UploadError=s;})();
